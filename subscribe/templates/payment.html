<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Confirmation</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    </style>
</head>

<body>
    <div class="container">
        <h2>Pay with Razorpay</h2>

        <div class="data-row">
            <span class="data-label">Client ID</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ clientId }}</span>
        </div>

        <div class="data-row">
            <span class="data-label">Name</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ clientName }}</span>
        </div>

        <div class="data-row">
            <span class="data-label">End Date</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ endDate }}</span>
        </div>

        <div class="data-row">
            <span class="data-label">Device ID</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ deviceId }}</span>
        </div>

        <div class="data-row">
            <span class="data-label">Channel ID</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ channelId }}</span>
        </div>

        <div class="data-row">
            <span class="data-label">Channel Name</span>
            <span class="data-colon">:</span>
            <span class="data-value">{{ channelName }}</span>
        </div>

        <button id="pay-btn">Pay Now</button>
    </div>


</body>

</html>

<script>
   document.getElementById('pay-btn').onclick = function () {
    console.log("🛎️ Pay button clicked");

    let csrfToken = getCookie("csrftoken");
    console.log("🔑 CSRF Token:", csrfToken);

    fetch('/subscribe/create_order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ amount: 500 })  // Amount in INR
    })
    .then(response => response.json())
    .then(order => {
        console.log("📜 Order Data:", order);

        if (order.error) {
            console.error("❌ Order Creation Failed:", order.error);
            window.location.href = "/subscribe/error/?error=" + encodeURIComponent(order.error);
            return;
        }

        var options = {
            "key": "{{ RAZORPAY_KEY_ID }}",
            "amount": order.amount,
            "currency": order.currency,
            "name": "Your Company Name",
            "description": "Test Transaction",
            "order_id": order.order_id,
            "handler": function (response) {
                console.log("💰 Payment Successful, Response:", response);

                fetch('/subscribe/verify_payment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("✅ Payment verification success. Redirecting to:", data.redirect_url);
                    window.location.href = data.redirect_url;
                })
                .catch(error => {
                    console.error("🚨 Error verifying payment:", error);
                    window.location.href = "/subscribe/error/?error=" + encodeURIComponent("Payment verification failed. Please try again.");
                });
            },
            "theme": { "color": "#3399cc" }
        };

        console.log("⚙️ Initializing Razorpay with options:", options);
        var rzp1 = new Razorpay(options);
        rzp1.open();
    })
    .catch(error => {
        console.error("🚨 Error creating order:", error);
        window.location.href = "/subscribe/error/?error=" + encodeURIComponent("Failed to create payment order. Please try again.");
    });
};


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>